# DNS详解
DNS是互联网核心协议之一。不管是上网浏览，还是编程开发，都需要了解一点它的知识。

## DNS是什么？

DNS全程Domain Name System，中文名为**域名系统**。它的作用很简单，就是根据你输入的域名查找出对应的IP地址。

最初，我们访问网站都是通过IP地址来访问的（现在你仍然可以通过IP访问）。由于ip长且难记，用户使用起来特别不方便，于是DNS出现了。通过输入简单好记的域名，DNS服务器会查找到对应的IP地址供浏览器访问。

你可以简单的理解为它是一个电话本，当你输入中文名，它会告诉你对应的电话号码。

举例说明，当我在浏览器输入```www.baidu.com```，通过DNS服务器查出它的IP地址为```163.177.151.110```，于是浏览器访问了```163.177.151.110```。

关于TPC/IP的更多相关知识，你可以阅读我写的[作为前端所要了解的TPC/IP]()。

## DNS服务器

那么，到底是谁在进行这一系列查询转换的工作呢？答案是**DNS服务器**。

相信不少同学在捣鼓路由器、wifi、进行科学上网以及使用游戏加速器时，都会遇到需要配置DNS服务器的情况，在win7系统上一般在这里设置

![](https://tva1.sinaimg.cn/large/006y8mN6gy1g6mkgwpl8pj30bi0bymy1.jpg)

这里设置的，就是DNS服务器的IP地址。我们通过这个IP地址连接DNS服务器，然后将域名告诉服务器，服务器在查到域名所对应的IP地址后将其返回给我们。如果DNS服务器的IP地址不正确，我们的计算机将直接上不了网。

DNS服务器的IP地址，有可能是动态的，每次上网时由网关分配，这叫做DHCP机制；也有可能是事先指定的固定地址，即我们这里配置的IP地址。

DNS服务器有很多，各大运营商有其自己的DNS服务器，一些著名服务公司也有其自己的DNS服务器。例如Google的```8.8.8.8```，国内114的```114.114.114.114```。

## hosts

DNS服务器不光在外网有，在你的计算机里面也有。在MAC端，它以没有扩展名的系统文件形式存在，路径一般为/etc/hosts。你可以使用记事本打开并编辑它。

![](https://tva1.sinaimg.cn/large/006y8mN6gy1g6mktmjfvhj30na06idg9.jpg)

在整个DNS查询中，最先搜索的就是本地的hosts文件，如果没有匹配才会再向上查找。

## 域名分级

在多年的网上“冲浪”生涯中，一定有人会问，为什么好多网站都是```www.xxxx.com```的结构？这就涉及到了域名分级的概念。

在域名系统中，域名被分成多个等级。它们以```.```分隔。

拿```www.example.com```举例。实际上，它的完整域名应该是```www.example.com.root```。最后的```.root```称作**根域名**。根域名对所有的域名都是一样的，所以平时我们都是省略的。

根域名下一级叫做**顶级域名**，比如```.com```、```.net```；再下一级叫做**次级域名**，比如此例中的```.example```；再下是主机名（host），又叫**三级域名**，比如此例中的```www```。

总结一下，域名的层级结构为**主机名.次级域名.顶级域名.根域名**。

![](https://tva1.sinaimg.cn/large/006y8mN6gy1g6mmlo25brj30mv0c5dib.jpg)

## 域名查询

在一次网页的访问过程中，对于常见的域名，DNS服务器一般会直接记录对应的IP（```A```记录）。但是对于那些不常见的域名，DNS服务器靠分级查询获知每个域名的IP地址（```NS```记录）。

还是拿```www.example.com```举例。

假设有一个不常见的域名进入到DNS服务器，那么它查询的过程大致如下：

1. 浏览器中输入```www.example.com```，发出解析请求；

2. 本机的域名解析器resolver程序查询本地缓存和host文件中是否为域名的映射关系，如果有则调用这个 IP 地址映射，完成解析；

3. 如果hosts与本地解析器缓存都没有相应的网址映射关系，则本地解析器会向TCP/IP参数中设置的首选DNS服务器（我们叫它Local DNS服务器）发起一个递归的查询请求；

4. 服务器收到查询时，如果要查询的域名由本机负责解析，则返回解析结果给客户机，完成域名解析，此解析具有权威性。如果要查询的域名，不由Local DNS服务器解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性；

5. 如果Local DNS服务器本地区域文件与缓存解析都失效，则根据Local DNS服务器的设置（是否递归）进行查询，如果未开启递归模式，Local DNS就把请求发至13台Root DNS。如果用的是递归模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环；

6. Root DNS服务器收到请求后会判断这个域名是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP；

7. Local DNS服务器收到IP信息后，将会联系负责```.com```域的这台服务器；

8. 负责```.com```域的服务器收到请求后，如果自己无法解析，它就会找一个管理```.com```域的下一级DNS服务器地址给本地DNS服务器；

9. 当Local DNS服务器收到这个地址后，就会找```example.com```域服务器，10、11重复上面的动作，进行查询；

10. 最后```www.example.com```返回需要解析的域名的IP地址给Local DNS服务器；

11. Local DNS服务器缓存这个解析结果（同时也会缓存，6、8、10返回的结果）；

12. Local DNS服务器同时将结果返回给本机域名解析器；
13. 本机缓存解析结果；

14. 本机解析器将结果返回给浏览器；

15. 浏览器通过返回的 IP 地址发起请求。

![](https://tva1.sinaimg.cn/large/006y8mN6gy1g6mml56a6wj30im0eq416.jpg)

### DNS的递归查询和迭代查询

递归查询：如果主机所询问的本地域名服务器不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户的身份，向其他根域名服务器继续发出查询请求报文，而不是让该主机自己进行下一步的查询。

迭代查询：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉本地域名服务器：你下一步应当向哪一个域名服务器进行查询。然后让本地域名服务器进行后续的查询，而不是替本地域名服务器进行后续的查询。

由此可见，客户端到 Local DNS 服务器，Local DNS 与上级 DNS 服务器之间属于递归查询；DNS 服务器与根 DNS 服务器之前属于迭代查询。

实际环境中，因为采用递归模式会导致 DNS 服务器流量很大，所以现在大多数的 DNS 都是迭代模式。

## DNS记录类型

域名与IP之间的对应关系，称为"记录"（record）。根据使用场景，"记录"可以分成不同的类型（type），前面已经看到了有```A```记录和```NS```记录。

常见的DNS记录类型如下。

1. A：地址记录（Address），返回域名指向的IP地址

2. NS：域名服务器记录（Name Server），返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为IP地址

3. MX：邮件记录（Mail eXchange），返回接收电子邮件的服务器地址

4. CNAME：规范名称记录（Canonical Name），返回另一个域名，即当前查询的域名是另一个域名的跳转

5. PTR：逆向查询记录（Pointer Record），只用于从IP地址查询域名

## DNS优化

一般来说，我们不会每次都由根域名开始查起，这样有些不“优雅”。

### hosts

实际上，hosts文件就是一种针对DNS的优化，将不常见的或访问不到的（内网）域名与其IP地址直接配置在hosts文件中。在访问域名的时候就能不通过DNS服务器查询直接访问IP地址。

### 
TODO: http://www.52im.net/thread-2121-1-1.html


## 参考

[DNS 原理入门](http://www.ruanyifeng.com/blog/2016/06/dns.html)  
[全面了解移动端DNS域名劫持等杂症：原理、根源、HttpDNS解决方案等](http://www.52im.net/thread-2121-1-1.html)